{% extends 'base.html' %}

{% block title %} Agricultural AI Assistant {% endblock %}

{% block content %}

<body>
    <a href="/" class="back-btn">‚Üê Back</a>

    <div class="chat-container">
        <div class="chat-header">
            <h1>üåæ Agricultural AI Assistant</h1>
            <p>Ask me about crop predictions, production data, and agriculture insights</p>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-content">
                    üëã Hello! I'm your agricultural assistant. I can help you with:
                    <br><br>
                    ‚Ä¢ Crop production forecasts<br>
                    ‚Ä¢ District-wise crop data<br>
                    ‚Ä¢ Hectare and yield information<br>
                    ‚Ä¢ Historical trends<br><br>
                    What would you like to know?
                </div>
            </div>

            <div class="suggestions" id="suggestions">
                <button class="suggestion-btn" onclick="sendMessage('What is the rice production forecast for 2024-25?')">Rice Production Forecast</button>
                <button class="suggestion-btn" onclick="sendMessage('Which districts produce the most wheat?')">Top Wheat Districts</button>
                <button class="suggestion-btn" onclick="sendMessage('Show me crop predictions')">Crop Predictions</button>
                <button class="suggestion-btn" onclick="sendMessage('What is the total area under cultivation?')">Total Cultivation Area</button>
            </div>
        </div>

        <div class="chat-input-area">
            <input
                type="text"
                class="chat-input"
                id="messageInput"
                placeholder="Ask me anything about crops..."
                onkeypress="handleKeyPress(event)"
            />
            <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()">
                ‚û§
            </button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            messageDiv.innerHTML = `<div class="message-content">${text}</div>`;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addLoadingMessage() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.id = 'loadingMessage';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="loading">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function removeLoadingMessage() {
            const loading = document.getElementById('loadingMessage');
            if (loading) loading.remove();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendMessage(customMessage = null) {
            const message = customMessage || messageInput.value.trim();

            if (!message) return;

            // Remove suggestions on first message
            const suggestions = document.getElementById('suggestions');
            if (suggestions) suggestions.remove();

            // Add user message
            addMessage(message, true);
            messageInput.value = '';
            sendBtn.disabled = true;

            // Add loading indicator
            addLoadingMessage();

            // Send to backend
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                removeLoadingMessage();

                if (data.success) {
                    addMessage(data.message, false);
                } else {
                    addMessage('Sorry, I encountered an error: ' + data.error, false);
                }

                sendBtn.disabled = false;
                messageInput.focus();
            })
            .catch(error => {
                removeLoadingMessage();
                addMessage('Network error. Please try again.', false);
                sendBtn.disabled = false;
                messageInput.focus();
            });
        }

        // Focus input on page load
        messageInput.focus();
    </script>
</body>
</html>
