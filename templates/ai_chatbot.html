<!-- ...existing code... -->
{% extends 'base.html' %}

{% block title %} Agricultural AI Assistant {% endblock %}

{% block content %}

<body>
    <a href="/" class="back-btn">‚Üê Back</a>

    <div class="chat-page">
        <div class="hero">
            <div class="hero-inner">
                <h1>üåæ Agricultural AI Assistant</h1>
                <p class="subtitle">Ask about crop predictions, production data, yields and top producers.</p>
            </div>
        </div>

        <main class="chat-container">
            <aside class="hero">
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value">+120</div>
                        <div class="stat-label">Datasets</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">50+</div>
                        <div class="stat-label">Crops</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">All</div>
                        <div class="stat-label">Districts</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="action-btn" onclick="sendMessage('Show crop predictions')">Show Predictions</button>
                    <button class="action-btn" onclick="sendMessage('Top producers for rice')">Top Producers</button>
                </div>
            </aside>

            <section class="chat-panel">
                <div class="chat-header">
                    <h2>Conversational Insights</h2>
                    <p class="muted">Type queries like "Rice forecast 2025" or use the suggestions below.</p>
                </div>

                <div class="chat-messages" id="chatMessages" aria-live="polite">
                    <div class="message bot">
                        <div class="message-content">
                            üëã Hello! I'm your agricultural assistant. I can help you with:
                            <br><br>
                            ‚Ä¢ Crop production forecasts<br>
                            ‚Ä¢ District-wise crop data<br>
                            ‚Ä¢ Hectare and yield information<br>
                            ‚Ä¢ Historical trends
                        </div>
                    </div>

                    <div class="suggestions" id="suggestions">
                        <button class="suggestion-btn" onclick="sendMessage('What is the rice production forecast for 2024-25?')">Rice Forecast</button>
                        <button class="suggestion-btn" onclick="sendMessage('Which districts produce the most wheat?')">Top Wheat Districts</button>
                        <button class="suggestion-btn" onclick="sendMessage('Show me crop predictions')">Crop Predictions</button>
                        <button class="suggestion-btn" onclick="sendMessage('What is the total area under cultivation?')">Total Cultivation Area</button>
                    </div>
                </div>

                <div class="chat-input-area">
                    <input
                        type="text"
                        class="chat-input"
                        id="messageInput"
                        placeholder="Ask anything about crops..."
                        onkeypress="handleKeyPress(event)"
                        aria-label="Message"
                    />
                    <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()" aria-label="Send">‚û§</button>
                </div>
            </section>
        </main>
    </div>

    <style>
        /* Page layout */
        body { margin: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(160deg,#f4fbff 0%, #eaf6ff 40%, #ffffff 100%); color:#0b2b3a; }
        .back-btn { display:inline-block;margin:18px 24px;color:#096; text-decoration:none; font-weight:600; }
        .chat-page { max-width:1200px; margin: 12px auto 48px; padding: 0 18px; }

        .hero { background:linear-gradient(90deg, rgba(6, 132, 120, .08), rgba(4, 102, 255, .04)); border-radius:12px; padding:20px; display:flex; align-items:center; margin-bottom:18px; box-shadow: 0 6px 20px rgba(6,18,38,0.05); }
        .hero-inner h1 { margin:0; font-size:22px; letter-spacing: -0.2px; }
        .subtitle { margin:6px 0 0; color:#235; opacity:.8; font-size:13px; }

        main.chat-container { display:grid; grid-template-columns: 220px 1fr; gap:18px; align-items:start; }
        .sidebar { background:#fff; border-radius:12px; padding:14px; box-shadow: 0 6px 18px rgba(4,20,48,0.04); }
        .stats { display:flex; gap:10px; justify-content:space-between; margin-bottom:12px; }
        .stat { text-align:center; padding:8px; background:linear-gradient(180deg,#fff,#f7fbff); border-radius:8px; flex:1; }
        .stat-value { font-weight:700; font-size:18px; color:#064a4a; }
        .stat-label { font-size:12px; color:#607; margin-top:4px; }

        .action-btn { display:block; width:100%; margin-top:8px; padding:8px; border-radius:8px; background:linear-gradient(90deg,#06b6a4,#0ea5e9); color:white; border:none; cursor:pointer; font-weight:600; }
        .action-btn:hover { transform:translateY(-1px); box-shadow: 0 6px 16px rgba(14,165,233,0.14); }

        .chat-panel { background: rgba(255,255,255,0.98); border-radius:12px; min-height:540px; display:flex; flex-direction:column; box-shadow: 0 8px 30px rgba(3,20,40,0.06); overflow:hidden; }
        .chat-header { padding:18px 20px 6px; border-bottom:1px solid #f1f7fb; }
        .chat-header h2 { margin:0; font-size:16px; }
        .muted { margin:6px 0 0; color:#567; font-size:12px; }

        .chat-messages { padding:18px; height:420px; overflow:auto; display:flex; flex-direction:column; gap:12px; background: linear-gradient(180deg, rgba(250,255,255,0.7), transparent); }
        .message { max-width:78%; padding:12px 14px; border-radius:12px; line-height:1.4; }
        .message.bot { background: linear-gradient(180deg,#f7fbff,#eef7ff); color:#073047; align-self:flex-start; box-shadow: 0 6px 18px rgba(2,30,54,0.03); }
        .message.user { background: linear-gradient(180deg,#06b6a4,#0ea5e9); color:#fff; align-self:flex-end; border-bottom-right-radius:4px; box-shadow: 0 8px 20px rgba(14,165,233,0.12); }

        .message-content { white-space:pre-wrap; word-break:break-word; font-size:14px; }

        .suggestions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        .suggestion-btn { background:transparent; border:1px solid #e0f2ff; padding:6px 10px; border-radius:999px; cursor:pointer; color:#036; font-weight:600; }
        .suggestion-btn:hover { background:#e6f7ff; transform:translateY(-2px); }

        .chat-input-area { display:flex; gap:10px; padding:14px; border-top:1px solid #f1f7fb; }
        .chat-input { flex:1; padding:12px 14px; border-radius:10px; border:1px solid #e6eef3; font-size:14px; outline:none; background:#fbfeff; }
        .chat-input:focus { box-shadow: 0 6px 18px rgba(8,64,120,0.06); border-color:#cceefb; }
        .chat-send-btn { width:56px; border-radius:10px; border:none; background:linear-gradient(180deg,#06b6a4,#0ea5e9); color:white; font-size:18px; cursor:pointer; box-shadow: 0 8px 18px rgba(14,165,233,0.14); }

        /* loading animation */
        .loading span { display:inline-block; width:8px; height:8px; margin-right:6px; background:#cfefff; border-radius:99px; animation: blink 1s infinite; }
        .loading span:nth-child(2) { animation-delay:0.15s; }
        .loading span:nth-child(3) { animation-delay:0.3s; }
        @keyframes blink { 0%,100% { opacity:.25; transform:translateY(0);} 50% { opacity:1; transform:translateY(-4px);} }

        /* Responsive */
        @media (max-width:880px) {
            main.chat-container { grid-template-columns: 1fr; }
            .sidebar { order:2; }
            .chat-panel { order:1; min-height:640px; }
        }
    </style>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        function scrollToBottom() {
            if (!chatMessages) return;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            messageDiv.innerHTML = `<div class="message-content">${text}</div>`;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addLoadingMessage() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.id = 'loadingMessage';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="loading">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function removeLoadingMessage() {
            const loading = document.getElementById('loadingMessage');
            if (loading) loading.remove();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage(customMessage = null) {
            const message = customMessage || messageInput.value.trim();
            if (!message) return;

            const suggestions = document.getElementById('suggestions');
            if (suggestions) suggestions.remove();

            addMessage(message, true);
            messageInput.value = '';
            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.7';

            addLoadingMessage();

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                const data = await res.json();
                removeLoadingMessage();

                if (data && data.success) {
                    addMessage(data.message, false);
                } else {
                    addMessage('Sorry, I encountered an error: ' + (data?.error || 'Unknown'), false);
                }
            } catch (err) {
                removeLoadingMessage();
                addMessage('Network error. Please try again.', false);
            } finally {
                sendBtn.disabled = false;
                sendBtn.style.opacity = '1';
                messageInput.focus();
            }
        }

        // focus on load
        messageInput?.focus();
    </script>
</body>
{% endblock %}
```<!-- filepath: /home/ubuntu/agri-base/templates/ai_chatbot.html -->
